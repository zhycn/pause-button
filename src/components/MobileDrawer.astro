---
// ç§»åŠ¨ç«¯æŠ½å±‰èœå•ç»„ä»¶
import SunIcon from './icons/SunIcon.astro';
import MoonIcon from './icons/MoonIcon.astro';

interface Props {
  locale: any;
  currentLang: string;
}

const { locale, currentLang } = Astro.props;
const supportedLangs = [
  { code: 'zh-CN', label: 'ä¸­æ–‡', flag: 'ğŸ‡¨ğŸ‡³' },
  { code: 'en', label: 'English', flag: 'ğŸ‡ºğŸ‡¸' }
];
---

<!-- ç§»åŠ¨ç«¯èœå•æŒ‰é’® -->
<button
  id="mobile-menu-btn"
  class="md:hidden p-2 text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-slate-100 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg transition-all duration-200"
  aria-label="æ‰“å¼€èœå•"
  aria-expanded="false"
>
  <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
  </svg>
</button>

<!-- æŠ½å±‰é®ç½©å±‚ -->
<div
  id="mobile-drawer-overlay"
  class="fixed inset-0 bg-black/50 backdrop-blur-sm z-40 opacity-0 pointer-events-none transition-opacity duration-300 md:hidden"
></div>

<!-- æŠ½å±‰èœå• -->
<aside
  id="mobile-drawer"
  class="fixed top-0 right-0 h-full w-80 max-w-[85vw] bg-white dark:bg-slate-950 shadow-2xl z-50 transform translate-x-full transition-transform duration-300 ease-out md:hidden"
  aria-label="ç§»åŠ¨ç«¯èœå•"
>
  <div class="flex flex-col h-full">
    <!-- æŠ½å±‰å¤´éƒ¨ -->
    <div class="flex items-center justify-between p-4 border-b border-slate-200 dark:border-slate-800">
      <h2 class="text-lg font-semibold text-slate-900 dark:text-slate-50">{locale.ui.language === 'Language' ? 'Menu' : 'èœå•'}</h2>
      <button
        id="mobile-drawer-close"
        class="p-2 text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-slate-100 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg transition-all duration-200"
        aria-label="å…³é—­èœå•"
      >
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>

    <!-- æŠ½å±‰å†…å®¹ -->
    <div class="flex-1 overflow-y-auto p-4 space-y-4">
      <!-- GitHub -->
      <div class="border-b border-gray-200 dark:border-gray-800 pb-4">
        <a
          href="https://github.com/zhycn/pause-button"
          target="_blank"
          rel="noopener noreferrer"
          class="flex items-center gap-3 p-3 text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg transition-colors duration-200"
        >
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path fill-rule="evenodd" d="M12 2C6.477 2 2 6.477 2 12c0 4.42 2.865 8.17 6.839 9.49.5.092.682-.217.682-.482 0-.237-.008-.866-.013-1.7-2.782.603-3.369-1.34-3.369-1.34-.454-1.156-1.11-1.463-1.11-1.463-.908-.62.069-.608.069-.608 1.003.07 1.531 1.03 1.531 1.03.892 1.529 2.341 1.087 2.91.831.092-.646.35-1.086.636-1.336-2.22-.253-4.555-1.11-4.555-4.943 0-1.091.39-1.984 1.029-2.683-.103-.253-.446-1.27.098-2.647 0 0 .84-.269 2.75 1.025A9.578 9.578 0 0112 6.836c.85.004 1.705.114 2.504.336 1.909-1.294 2.747-1.025 2.747-1.025.546 1.377.203 2.394.1 2.647.64.699 1.028 1.592 1.028 2.683 0 3.842-2.339 4.687-4.566 4.935.359.309.678.919.678 1.852 0 1.336-.012 2.415-.012 2.743 0 .267.18.578.688.48C19.138 20.167 22 16.418 22 12c0-5.523-4.477-10-10-10z" clip-rule="evenodd"/>
          </svg>
          <span class="font-medium">GitHub</span>
        </a>
      </div>

      <!-- è¯­è¨€åˆ‡æ¢ -->
      <div class="border-b border-gray-200 dark:border-gray-800 pb-4">
        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">
          {locale.ui.language}
        </label>
        <select
          id="mobile-lang-switcher"
          class="w-full px-4 py-2.5 text-sm font-medium text-slate-700 dark:text-slate-200 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-lg focus:outline-none focus:ring-2 focus:ring-slate-400/50 dark:focus:ring-slate-600/50 transition-all shadow-sm"
          data-current-lang={currentLang}
        >
          {supportedLangs.map((lang) => (
            <option value={lang.code} selected={lang.code === currentLang}>
              {lang.flag} {lang.label}
            </option>
          ))}
        </select>
      </div>

      <!-- ä¸»é¢˜åˆ‡æ¢ -->
      <div>
        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">
          {locale.ui.theme}
        </label>
        <button
          id="mobile-theme-switcher"
          type="button"
          class="w-full flex items-center justify-between p-3 text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg transition-colors duration-200 shadow-sm"
        >
          <span class="font-medium">
            <span id="mobile-theme-label">{locale.ui.theme}</span>
          </span>
          <div class="flex items-center gap-2">
            <SunIcon id="mobile-sun-icon" class="w-5 h-5" />
            <MoonIcon id="mobile-moon-icon" class="w-5 h-5" style="display: none;" />
          </div>
        </button>
      </div>
    </div>
  </div>
</aside>

<script is:inline>
  (function() {
    function initMobileDrawer() {
      const menuBtn = document.getElementById('mobile-menu-btn');
      const drawer = document.getElementById('mobile-drawer');
      const overlay = document.getElementById('mobile-drawer-overlay');
      const closeBtn = document.getElementById('mobile-drawer-close');
      const langSwitcher = document.getElementById('mobile-lang-switcher');
      const themeSwitcher = document.getElementById('mobile-theme-switcher');
      const themeLabel = document.getElementById('mobile-theme-label');
      const sunIcon = document.getElementById('mobile-sun-icon');
      const moonIcon = document.getElementById('mobile-moon-icon');

      if (!menuBtn || !drawer || !overlay) return;

      let isOpen = false;

      function openDrawer() {
        isOpen = true;
        drawer.classList.remove('translate-x-full');
        overlay.classList.remove('opacity-0', 'pointer-events-none');
        overlay.classList.add('opacity-100', 'pointer-events-auto');
        menuBtn.setAttribute('aria-expanded', 'true');
        document.body.style.overflow = 'hidden';
      }

      function closeDrawer() {
        isOpen = false;
        drawer.classList.add('translate-x-full');
        overlay.classList.remove('opacity-100', 'pointer-events-auto');
        overlay.classList.add('opacity-0', 'pointer-events-none');
        menuBtn.setAttribute('aria-expanded', 'false');
        document.body.style.overflow = '';
      }

      menuBtn.addEventListener('click', openDrawer);
      closeBtn?.addEventListener('click', closeDrawer);
      overlay.addEventListener('click', closeDrawer);

      // ESC é”®å…³é—­
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && isOpen) {
          closeDrawer();
        }
      });

      // è¯­è¨€åˆ‡æ¢
      if (langSwitcher) {
        // åˆå§‹åŒ–selectå€¼
        const initialLang = langSwitcher.getAttribute('data-current-lang') || 'zh-CN';
        if (langSwitcher.value !== initialLang) {
          langSwitcher.value = initialLang;
        }
        
        langSwitcher.addEventListener('change', function(e) {
          const newLang = langSwitcher.value;
          
          // éªŒè¯è¯­è¨€ä»£ç 
          if (!newLang || !['zh-CN', 'en'].includes(newLang)) {
            // æ¢å¤åŸå€¼
            const currentLang = langSwitcher.getAttribute('data-current-lang') || 'zh-CN';
            langSwitcher.value = currentLang;
            return;
          }
          
          // è·å–å½“å‰URLä¸­çš„è¯­è¨€å‚æ•°
          const urlParams = new URLSearchParams(window.location.search);
          const currentLangParam = urlParams.get('lang') || 'zh-CN';
          
          // å¦‚æœé€‰æ‹©çš„æ˜¯å½“å‰è¯­è¨€ï¼Œä¸åšä»»ä½•æ“ä½œ
          if (newLang === currentLangParam) {
            langSwitcher.value = currentLangParam;
            return;
          }
          
          // å…³é—­æŠ½å±‰
          if (isOpen) {
            closeDrawer();
          }
          
          // åˆ‡æ¢è¯­è¨€ - é‡æ–°åŠ è½½é¡µé¢
          try {
            // æ„å»ºæ–°çš„URLï¼Œä¿ç•™å…¶ä»–æŸ¥è¯¢å‚æ•°
            const url = new URL(window.location.href);
            url.searchParams.set('lang', newLang);
            const newUrl = url.toString();
            
            // å¼ºåˆ¶é¡µé¢é‡æ–°åŠ è½½
            window.location.href = newUrl;
          } catch (error) {
            console.error('Failed to switch language:', error);
            // æ¢å¤åŸå€¼
            const currentLang = langSwitcher.getAttribute('data-current-lang') || 'zh-CN';
            langSwitcher.value = currentLang;
          }
        });
      }

      // ä¸»é¢˜åˆ‡æ¢
      if (themeSwitcher) {
        function getTheme() {
          if (typeof localStorage !== 'undefined') {
            const stored = localStorage.getItem('theme');
            if (stored === 'dark' || stored === 'light') {
              return stored;
            }
          }
          return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        }

        function setTheme(theme) {
          if (theme === 'dark') {
            document.documentElement.classList.add('dark');
          } else {
            document.documentElement.classList.remove('dark');
          }
          if (typeof localStorage !== 'undefined') {
            localStorage.setItem('theme', theme);
          }
          window.dispatchEvent(new CustomEvent('themechange', { detail: { theme } }));
        }

        function updateMobileTheme() {
          const isDark = document.documentElement.classList.contains('dark');
          if (sunIcon && moonIcon) {
            sunIcon.style.display = isDark ? 'none' : 'block';
            moonIcon.style.display = isDark ? 'block' : 'none';
          }
        }

        themeSwitcher.addEventListener('click', function(e) {
          e.preventDefault();
          const currentTheme = getTheme();
          const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
          setTheme(newTheme);
          updateMobileTheme();
        });

        // ç›‘å¬ä¸»é¢˜å˜åŒ–
        window.addEventListener('themechange', updateMobileTheme);

        updateMobileTheme();
      }
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initMobileDrawer);
    } else {
      initMobileDrawer();
    }
  })();
</script>
