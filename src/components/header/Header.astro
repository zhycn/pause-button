---
import type { Locale } from '../../types/locale';
import type { SupportedLocale } from '../../i18n';
import Brand from './Brand.astro';
import Github from './Github.astro';
import Language from './Language.astro';
import Theme from './Theme.astro';
import GithubIcon from '../icons/GithubIcon.astro';
import SunIcon from '../icons/SunIcon.astro';
import MoonIcon from '../icons/MoonIcon.astro';

interface Props {
  locale: Locale;
  currentLang: SupportedLocale;
}

const { locale, currentLang } = Astro.props;

const supportedLangs = [
  { code: 'zh-CN' as SupportedLocale, label: '‰∏≠Êñá', flag: 'üá®üá≥' },
  { code: 'en' as SupportedLocale, label: 'English', flag: 'üá∫üá∏' }
];
---

<header class="fixed top-0 left-0 right-0 z-50 bg-white dark:bg-gray-950 border-b border-gray-200 dark:border-gray-800">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex items-center justify-between h-16">
      <!-- Brand (Left) -->
      <div class="flex items-center">
        <Brand />
      </div>

      <!-- Desktop Navigation (Right) -->
      <nav class="hidden md:flex items-center gap-1" aria-label="Navigation">
        <Github />
        <Language locale={locale} currentLang={currentLang} />
        <Theme locale={locale} />
      </nav>

      <!-- Mobile Menu Button -->
      <button
        id="mobile-menu-btn"
        type="button"
        class="md:hidden p-2 rounded-lg transition-all duration-200 hover:bg-gray-100 dark:hover:bg-gray-800 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-blue-500 text-gray-700 dark:text-gray-300"
        aria-label="ÊâìÂºÄËèúÂçï"
        aria-expanded="false"
      >
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
        </svg>
      </button>
    </div>
  </div>

  <!-- Mobile Drawer Overlay -->
  <div
    id="mobile-drawer-overlay"
    class="fixed inset-0 bg-black/50 backdrop-blur-sm z-40 opacity-0 invisible transition-all duration-300 md:hidden"
  ></div>

  <!-- Mobile Drawer Menu -->
  <aside
    id="mobile-drawer"
    class="fixed top-0 right-0 h-full w-80 max-w-[85vw] bg-white dark:bg-gray-950 shadow-2xl z-50 transform translate-x-full transition-transform duration-300 ease-out md:hidden border-l border-gray-200 dark:border-gray-800"
    aria-label="ÁßªÂä®Á´ØËèúÂçï"
  >
    <div class="flex flex-col h-full">
      <!-- Drawer Header -->
      <div class="flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-800">
        <h2 class="text-lg font-semibold text-gray-900 dark:text-gray-50">
          {locale.ui.language === 'Language' ? 'Menu' : 'ËèúÂçï'}
        </h2>
        <button
          id="mobile-drawer-close"
          type="button"
          class="p-2 rounded-lg transition-all duration-200 hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-blue-500"
          aria-label="ÂÖ≥Èó≠ËèúÂçï"
        >
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>

      <!-- Drawer Content -->
      <div class="flex-1 overflow-y-auto p-4 space-y-4">
        <!-- GitHub -->
        <div class="border-b border-gray-200 dark:border-gray-800 pb-4">
          <a
            href="https://github.com/zhycn/pause-button"
            target="_blank"
            rel="noopener noreferrer"
            class="flex items-center gap-3 p-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg transition-colors duration-200"
          >
            <GithubIcon size={20} />
            <span class="font-medium">GitHub</span>
          </a>
        </div>

        <!-- Language Switcher -->
        <div class="border-b border-gray-200 dark:border-gray-800 pb-4">
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            {locale.ui.language}
          </label>
          <div class="space-y-1">
            {supportedLangs.map((lang) => (
              <a
                href={`?lang=${lang.code}`}
                class={`flex items-center gap-3 px-4 py-2.5 text-sm font-medium rounded-lg transition-colors duration-200 ${
                  lang.code === currentLang
                    ? 'bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400'
                    : 'text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800'
                }`}
              >
                <span>{lang.flag}</span>
                <span>{lang.label}</span>
                {lang.code === currentLang && (
                  <svg class="w-4 h-4 ml-auto" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                  </svg>
                )}
              </a>
            ))}
          </div>
        </div>

        <!-- Theme Switcher -->
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            {locale.ui.theme}
          </label>
          <button
            id="mobile-theme-switcher"
            type="button"
            class="w-full flex items-center justify-between p-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg transition-colors duration-200"
          >
            <span class="font-medium">{locale.ui.theme}</span>
            <div class="flex items-center gap-2">
              <SunIcon id="mobile-sun-icon" size={20} class="w-5 h-5" />
              <MoonIcon id="mobile-moon-icon" size={20} class="w-5 h-5 hidden dark:block" />
            </div>
          </button>
        </div>
      </div>
    </div>
  </aside>
</header>

<script>
  (function() {
    'use strict';
    
    function initMobileDrawer() {
      const menuBtn = document.getElementById('mobile-menu-btn');
      const drawer = document.getElementById('mobile-drawer');
      const overlay = document.getElementById('mobile-drawer-overlay');
      const closeBtn = document.getElementById('mobile-drawer-close');
      const themeSwitcher = document.getElementById('mobile-theme-switcher');
      const sunIcon = document.getElementById('mobile-sun-icon');
      const moonIcon = document.getElementById('mobile-moon-icon');

      if (!menuBtn || !drawer || !overlay) return;

      let isOpen = false;

      function openDrawer() {
        isOpen = true;
        drawer.classList.remove('translate-x-full');
        overlay.classList.remove('opacity-0', 'invisible');
        overlay.classList.add('opacity-100', 'visible');
        menuBtn.setAttribute('aria-expanded', 'true');
        document.body.style.overflow = 'hidden';
      }

      function closeDrawer() {
        isOpen = false;
        drawer.classList.add('translate-x-full');
        overlay.classList.remove('opacity-100', 'visible');
        overlay.classList.add('opacity-0', 'invisible');
        menuBtn.setAttribute('aria-expanded', 'false');
        document.body.style.overflow = '';
      }

      menuBtn.addEventListener('click', openDrawer);
      closeBtn?.addEventListener('click', closeDrawer);
      overlay.addEventListener('click', closeDrawer);

      // ESC ÈîÆÂÖ≥Èó≠
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && isOpen) {
          closeDrawer();
        }
      });

      // Mobile Theme Switcher
      if (themeSwitcher) {
        function getTheme() {
          if (typeof localStorage !== 'undefined') {
            const stored = localStorage.getItem('theme');
            if (stored === 'dark' || stored === 'light') {
              return stored;
            }
          }
          return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        }

        function setTheme(theme: 'dark' | 'light') {
          if (theme === 'dark') {
            document.documentElement.classList.add('dark');
          } else {
            document.documentElement.classList.remove('dark');
          }
          if (typeof localStorage !== 'undefined') {
            localStorage.setItem('theme', theme);
          }
          updateMobileTheme();
        }

        function updateMobileTheme() {
          const isDark = document.documentElement.classList.contains('dark');
          if (sunIcon && moonIcon) {
            if (isDark) {
              sunIcon.classList.add('hidden');
              moonIcon.classList.remove('hidden');
            } else {
              sunIcon.classList.remove('hidden');
              moonIcon.classList.add('hidden');
            }
          }
        }

        themeSwitcher.addEventListener('click', function(e) {
          e.preventDefault();
          const currentTheme = getTheme();
          const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
          setTheme(newTheme);
        });

        // ÁõëÂê¨‰∏ªÈ¢òÂèòÂåñ
        const observer = new MutationObserver(() => {
          updateMobileTheme();
        });
        observer.observe(document.documentElement, {
          attributes: true,
          attributeFilter: ['class']
        });

        updateMobileTheme();
      }
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initMobileDrawer);
    } else {
      setTimeout(initMobileDrawer, 0);
    }
  })();
</script>
