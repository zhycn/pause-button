---
import Logo from './Logo.astro';
import GithubIcon from './GithubIcon.astro';
import MobileDrawer from './MobileDrawer.astro';

interface Props {
  locale: any;
  currentLang: string;
}

const { locale, currentLang } = Astro.props;
const supportedLangs = [
  { code: 'zh-CN', label: 'ä¸­æ–‡', flag: 'ğŸ‡¨ğŸ‡³' },
  { code: 'en', label: 'English', flag: 'ğŸ‡ºğŸ‡¸' }
];
---

<header class="fixed top-0 left-0 right-0 z-50 bg-white/95 dark:bg-slate-950/95 backdrop-blur-xl border-b border-gray-200/60 dark:border-slate-800/60 shadow-sm">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex items-center justify-between h-16">
      <!-- Logo -->
      <Logo />

      <!-- Desktop Navigation -->
      <nav class="hidden md:flex items-center gap-2 lg:gap-3" aria-label="Navigation">
        <!-- GitHub -->
        <GithubIcon />

        <!-- Language Switcher -->
        <div class="relative">
          <select
            id="lang-switcher"
            aria-label={locale.ui.language}
            class="appearance-none pl-3 pr-8 py-2 text-sm font-medium text-slate-700 dark:text-slate-200 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-800 focus:outline-none focus:ring-2 focus:ring-slate-400/50 dark:focus:ring-slate-600/50 focus:border-transparent transition-all duration-200 cursor-pointer min-w-[120px] shadow-sm"
            data-current-lang={currentLang}
          >
            {supportedLangs.map((lang) => (
              <option value={lang.code} selected={lang.code === currentLang}>
                {lang.flag} {lang.label}
              </option>
            ))}
          </select>
          <!-- Custom dropdown arrow -->
          <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-2.5">
            <svg class="w-4 h-4 text-gray-500 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
            </svg>
          </div>
        </div>

        <!-- Theme Switcher -->
        <button
          id="theme-switcher"
          type="button"
          class="p-2.5 text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-slate-100 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg transition-all duration-200 group shadow-sm"
          aria-label={locale.ui.theme}
          aria-pressed="false"
        >
          <!-- Sun icon (light mode) -->
          <svg id="sun-icon" class="w-5 h-5 hidden dark:block transition-transform group-hover:rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M12 21a9 9 0 1 1 0-18 9 9 0 0 1 0 18z"/>
          </svg>
          <!-- Moon icon (dark mode) -->
          <svg id="moon-icon" class="w-5 h-5 block dark:hidden transition-transform group-hover:-rotate-12" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 0 1 8.646 3.646 9 9 0 1 0 18 9 9 9 0 0 1 15.354 20.354z"/>
          </svg>
        </button>
      </nav>

      <!-- Mobile Menu Button -->
      <MobileDrawer locale={locale} currentLang={currentLang} />
    </div>
  </div>
</header>

<script is:inline>
  (function() {
    'use strict';
    
      function initHeader() {
      // ä¸»é¢˜ç®¡ç†
      function getTheme() {
        if (typeof localStorage !== 'undefined') {
          const stored = localStorage.getItem('theme');
          if (stored === 'dark' || stored === 'light') {
            return stored;
          }
        }
        return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
      }

      function setTheme(theme) {
        if (theme === 'dark') {
          document.documentElement.classList.add('dark');
        } else {
          document.documentElement.classList.remove('dark');
        }
        if (typeof localStorage !== 'undefined') {
          localStorage.setItem('theme', theme);
        }
        // é€šçŸ¥å…¶ä»–ç»„ä»¶
        if (typeof window !== 'undefined') {
          window.dispatchEvent(new CustomEvent('themechange', { detail: { theme } }));
        }
      }

      function updateThemeButton() {
        const isDark = document.documentElement.classList.contains('dark');
        const themeSwitcher = document.getElementById('theme-switcher');
        if (themeSwitcher) {
          themeSwitcher.setAttribute('aria-pressed', isDark.toString());
        }
      }

      // Theme switcher
      const themeSwitcher = document.getElementById('theme-switcher');
      if (themeSwitcher) {
        // åˆå§‹åŒ–æŒ‰é’®çŠ¶æ€
        updateThemeButton();
        
        themeSwitcher.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          const currentTheme = getTheme();
          const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
          setTheme(newTheme);
          updateThemeButton();
        });

        // ç›‘å¬ä¸»é¢˜å˜åŒ–äº‹ä»¶ï¼ˆæ¥è‡ªå…¶ä»–ç»„ä»¶ï¼‰
        if (typeof window !== 'undefined') {
          window.addEventListener('themechange', function(e) {
            updateThemeButton();
          });
        }
      }

      // Language switcher
      const langSwitcher = document.getElementById('lang-switcher');
      if (langSwitcher) {
        // åˆå§‹åŒ–selectå€¼
        const initialLang = langSwitcher.getAttribute('data-current-lang') || 'zh-CN';
        if (langSwitcher.value !== initialLang) {
          langSwitcher.value = initialLang;
        }
        
        langSwitcher.addEventListener('change', function(e) {
          const newLang = langSwitcher.value;
          
          // éªŒè¯è¯­è¨€ä»£ç 
          if (!newLang || !['zh-CN', 'en'].includes(newLang)) {
            // æ¢å¤åŸå€¼
            const currentLang = langSwitcher.getAttribute('data-current-lang') || 'zh-CN';
            langSwitcher.value = currentLang;
            return;
          }
          
          // è·å–å½“å‰URLä¸­çš„è¯­è¨€å‚æ•°
          const urlParams = new URLSearchParams(window.location.search);
          const currentLangParam = urlParams.get('lang') || 'zh-CN';
          
          // å¦‚æœé€‰æ‹©çš„æ˜¯å½“å‰è¯­è¨€ï¼Œä¸åšä»»ä½•æ“ä½œ
          if (newLang === currentLangParam) {
            langSwitcher.value = currentLangParam;
            return;
          }
          
          // åˆ‡æ¢è¯­è¨€ - é‡æ–°åŠ è½½é¡µé¢
          try {
            // æ„å»ºæ–°çš„URLï¼Œä¿ç•™å…¶ä»–æŸ¥è¯¢å‚æ•°
            const url = new URL(window.location.href);
            url.searchParams.set('lang', newLang);
            const newUrl = url.toString();
            
            // å¼ºåˆ¶é¡µé¢é‡æ–°åŠ è½½
            window.location.href = newUrl;
          } catch (error) {
            console.error('Failed to switch language:', error);
            // æ¢å¤åŸå€¼
            const currentLang = langSwitcher.getAttribute('data-current-lang') || 'zh-CN';
            langSwitcher.value = currentLang;
          }
        });
      }
    }

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initHeader);
    } else {
      initHeader();
    }
  })();
</script>
