---
// 主题切换组件
import SunIcon from './icons/SunIcon.astro';
import MoonIcon from './icons/MoonIcon.astro';
---

<button
  id="theme-toggle"
  class="fixed top-4 right-4 sm:top-6 sm:right-6 z-40 p-3 rounded-xl bg-white/80 dark:bg-slate-800/80 backdrop-blur-md border border-slate-200 dark:border-slate-700 shadow-lg hover:shadow-xl transition-all duration-200 hover:scale-105 active:scale-95 focus:outline-none focus:ring-2 focus:ring-slate-400/30 dark:focus:ring-slate-600/30"
  aria-label="切换主题"
  title="切换明暗主题"
>
  <!-- 太阳图标（亮色模式） -->
  <SunIcon 
    id="sun-icon"
    class="w-5 h-5 text-slate-700 transition-opacity duration-200" 
  />
  
  <!-- 月亮图标（暗色模式） -->
  <MoonIcon 
    id="moon-icon"
    class="w-5 h-5 text-slate-300 transition-opacity duration-200" 
    style="display: none;"
  />
</button>

<script is:inline>
  (function() {
    function initTheme() {
      const themeToggle = document.getElementById('theme-toggle');
      const sunIcon = document.getElementById('sun-icon');
      const moonIcon = document.getElementById('moon-icon');
      
      if (!themeToggle) {
        setTimeout(initTheme, 100);
        return;
      }
      
      // 获取当前主题
      function getTheme() {
        if (typeof localStorage !== 'undefined') {
          const stored = localStorage.getItem('theme');
          if (stored === 'dark' || stored === 'light') {
            return stored;
          }
        }
        return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
      }
      
      // 更新图标显示
      function updateIcons(theme) {
        if (sunIcon && moonIcon) {
          if (theme === 'dark') {
            // 暗色模式：显示月亮，隐藏太阳
            sunIcon.style.display = 'none';
            moonIcon.style.display = 'block';
          } else {
            // 亮色模式：显示太阳，隐藏月亮
            sunIcon.style.display = 'block';
            moonIcon.style.display = 'none';
          }
        }
      }
      
      // 应用主题
      function setTheme(theme) {
        if (theme === 'dark') {
          document.documentElement.classList.add('dark');
        } else {
          document.documentElement.classList.remove('dark');
        }
        if (typeof localStorage !== 'undefined') {
          localStorage.setItem('theme', theme);
        }
        updateIcons(theme);
      }
      
      // 初始化主题
      const initialTheme = getTheme();
      setTheme(initialTheme);
      
      // 切换主题
      themeToggle.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        const currentTheme = getTheme();
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        setTheme(newTheme);
      });
      
      // 监听系统主题变化
      if (window.matchMedia) {
        const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
        mediaQuery.addEventListener('change', function(e) {
          // 只有在用户没有手动设置主题时才跟随系统
          if (!localStorage.getItem('theme')) {
            setTheme(e.matches ? 'dark' : 'light');
          }
        });
      }
    }
    
    // 多种方式确保 DOM 准备好
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initTheme);
    } else {
      initTheme();
    }
  })();
</script>
